<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Bets Scenario - Sports Betting Bonus Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2c2c2c;
            --text-color: #e0e0e0;
            --accent-color: #00aaff;
            --hover-color: #0077cc;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 40px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .intro, .formulas, .inputs, .notation, .optimality {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            box-shadow: var(--shadow);
        }

        .back-link {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
            text-decoration: none;
        }

        .back-link:hover {
            color: var(--hover-color);
        }

        label {
            display: block;
            margin: 10px 0;
        }

        input {
            background: #333;
            color: var(--text-color);
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
        }

        button {
            background: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background: var(--hover-color);
        }

        canvas {
            max-width: 100%;
            margin-top: 20px;
        }

        .notation table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .notation th, .notation td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .notation th {
            background: #333;
        }

        @media (max-width: 600px) {
            body {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body onload="plotOptimality()">
    <div class="container">
        <a href="index.html" class="back-link">← Back to Home</a>
        <header>
            <h1>Free Bets Scenario</h1>
            <div class="intro">
                <p>In this scenario, we analyze the hedging strategy for free bets. A free bet allows you to place a bet without risking your own money, but typically only returns the profit if it wins (not the stake). We hedge it with a cash bet on the opposite outcome to lock in a guaranteed profit.</p>
            </div>
        </header>

        <section class="formulas">
            <h2>Key Formulas</h2>
            <p>The hedge amount \(X\) is calculated to balance the outcomes:</p>
            \[ c X = (\bar{c} - 1) F \]
            <p>Where \(\bar{c}\) is derived from the expected return \(r\):</p>
            \[ \bar{c} = \frac{1}{\frac{1}{r} - \frac{1}{c}} = \frac{r c}{c - r} \]
            <p>The guaranteed profit \(G = (c - 1) X\), and the conversion rate is \(G / F = \frac{(c - 1)(\bar{c} - 1)}{c}\), which we aim to maximize.</p>
        </section>

        <section class="inputs" style="align-items: center; display: flex; flex-direction: row; gap: 10px;">
            <div>
                <h2>Input Parameters</h2>
                <label>Free Bet Amount (F): <input id="F" type="number" step="0.01" min="0" value="100"></label>
                <label>Expected Return (r): <input id="r" type="number" step="0.01" min="0.01" max="0.99" value="0.95"></label>
                <label>Max Cash for Hedge (max X): <input id="maxX" type="number" step="0.01" min="0" value="1000"></label>
                <button onclick="calculateFreebets()">Calculate and Plot</button>
            </div>
            <div class="results" id="results">
                <!-- Results will be inserted here -->
            </div>
        </section>

        <section>
            <canvas id="graph"></canvas>
        </section>

        <section class="optimality" style="margin-top:10px">
            <h2>Optimality Analysis</h2>
            <p>There is a direct formula relating the maximum guaranteed profit G to the expected return r:</p>
            \[ G = F \left(1 - \sqrt{\frac{1 - r}{r}}\right)^2 \]
            <p>This formula gives the highest possible conversion rate for a free bet under the given r, assuming no limit on the hedge amount X. Note that r=1 is theoretically interesting (yielding 100% conversion) but impossible in practice due to platform margins.</p>
            <h3>Maximum Conversion Rate vs r (0.85 to 0.99)</h3>
            <canvas id="optimalityGraph"></canvas>
            <h3>Proof</h3>
            <p>Starting with these equations to maximize G(r)</p>
            \[ (1)~~ \bar{c} = \frac{1}{\frac{1}{r} - \frac{1}{c}} = \frac{r c}{c - r} \]
            \[ (2)~~ G(r) = max_{c\in r}( (c - 1) X) \]
            \[ (3)~~ cX = (\bar{c} - 1) F \]
            <p>This gives the \( \rho=G/F \) that needs to be maximized over c:</p>
            \[ (4)~~ \rho = \frac{G}{F} = r \frac{c - 1}{c - r} - \frac{c - 1}{c} \]
            <p>Differentiating then setting to zero gives the optimal c. From there we can easily find the maximum conversion rate.</p>
        </section>
    </div>

    <script>function plotOptimality() {
            let rs = [];
            let rates = [];
            let xfs = [];
            for (let ri = 0.85; ri <= 0.99; ri += 0.01) {
                let r = Math.round(ri * 100) / 100;
                let m = 1 / r;
                let sqrt_term = Math.sqrt((1 - r) / r);
                let rate = Math.pow(1 - sqrt_term, 2) * 100;
                let p = m - sqrt_term; // Optimal p
                let q = sqrt_term; // Optimal q
                let c = 1 / p;
                let barc = 1 / q;
                let xf = (barc - 1) / c; // X/F = (bar c - 1) / c
                rs.push(r);
                rates.push(rate.toFixed(2));
                xfs.push(xf.toFixed(2));
            }
            const ctx = document.getElementById('optimalityGraph').getContext('2d');
            if (window.optChart) window.optChart.destroy();
            window.optChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: rs,
                    datasets: [
                        {
                            label: 'Max Conversion Rate (%)',
                            data: rates,
                            borderColor: 'rgba(153, 102, 255, 1)',
                            yAxisID: 'y',
                            fill: false
                        },
                        {
                            label: 'Optimal X/F',
                            data: xfs,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            yAxisID: 'y1',
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: 'Expected Return r' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Max Conversion Rate (%)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Optimal X/F' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function calculateFreebets() {
            const F = parseFloat(document.getElementById('F').value);
            const r = parseFloat(document.getElementById('r').value);
            const maxX = parseFloat(document.getElementById('maxX').value);

            if (isNaN(F) || isNaN(r) || isNaN(maxX) || F <= 0 || r <= 0 || r >= 1 || maxX <= 0) {
                alert('Invalid inputs. Please check values.');
                return;
            }

            const max_c = Math.min(r / (1 - r) - 0.01, 10);
            const step = 0.05;
            let cs = [];
            let convs = [];
            let Xs = [];
            let max_rate = 0;
            let c_opt = 1.01;
            let barc_opt = 0;
            let X_opt = 0;
            let G_opt = 0;

            // Loop to find optimal (unconstrained) and generate data, but only add to plot if X <= maxX
            for (let ci = 1.05; ci < max_c; ci += step) {
                let c = Math.round(ci * 100) / 100;
                let barc_inv = (1 / r) - (1 / c);
                if (barc_inv <= 0) continue;
                let barc = 1 / barc_inv;
                if (barc <= 1) continue;
                let rate = (c - 1) * (barc - 1) / c;
                let X_val = F * (barc - 1) / c;

                // For optimal, consider all
                if (rate > max_rate) {
                    max_rate = rate;
                    c_opt = c;
                    barc_opt = barc;
                    X_opt = X_val;
                    G_opt = rate * F;
                }

                // For plot, only if X_val <= maxX
                if (X_val <= maxX) {
                    cs.push(c.toFixed(2));
                    convs.push((rate * 100).toFixed(2));
                    Xs.push(X_val.toFixed(2));
                }
            }

            // Find constrained if necessary
            let c_constr = null;
            let barc_constr = null;
            let X_constr = null;
            let G_constr = null;
            let rate_constr = null;
            if (X_opt > maxX) {
                // Binary search for c where X(c) ≈ maxX
                let low = 1.01;
                let high = max_c;
                let mid;
                for (let i = 0; i < 50; i++) {
                    mid = (low + high) / 2;
                    const barc_mid = r * mid / (mid - r);
                    const X_mid = F * (barc_mid - 1) / mid;
                    if (X_mid > maxX) {
                        low = mid;
                    } else {
                        high = mid;
                    }
                }
                c_constr = low; // Since X decreases with c, for X= maxX at this c
                barc_constr = r * c_constr / (c_constr - r);
                X_constr = F * (barc_constr - 1) / c_constr;
                rate_constr = (c_constr - 1) * (barc_constr - 1) / c_constr;
                G_constr = rate_constr * F;
            }

            // Display results
            let results_html = `
                <h3>Unconstrained Optimal</h3>
                <p>c : ${c_opt.toFixed(2)}</p>
                <p>c̄ : ${barc_opt.toFixed(2)}</p>
                <p>X: $${X_opt.toFixed(2)}</p>
                <p>G: $${G_opt.toFixed(2)}</p>
                <p>Conversion Rate: ${(max_rate * 100).toFixed(2)}%</p>
            `;
            if (c_constr) {
                results_html += `
                    <h3>Constrained Optimal (max X = $${maxX.toFixed(2)})</h3>
                    <p>c: ${c_constr.toFixed(2)}</p>
                    <p>\(\bar{c}\): ${barc_constr.toFixed(2)}</p>
                    <p>X: $${X_constr.toFixed(2)}</p>
                    <p>G: $${G_constr.toFixed(2)}</p>
                    <p>Conversion Rate: ${(rate_constr * 100).toFixed(2)}%</p>
                `;
            } else {
                results_html += `<p>The optimal is within your max cash limit.</p>`;
            }
            document.getElementById('results').innerHTML = results_html;
            MathJax.typeset(); // Re-render MathJax

            // Plot
            const ctx = document.getElementById('graph').getContext('2d');
            if (window.chart) window.chart.destroy();
            window.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: cs,
                    datasets: [
                        {
                            label: 'Conversion Rate (%)',
                            data: convs,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            yAxisID: 'y',
                            fill: false
                        },
                        {
                            label: 'Hedge Amount X ($)',
                            data: Xs,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            yAxisID: 'y1',
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: { display: true, text: 'c (Hedge Odds)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Conversion Rate (%)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Hedge Amount X ($)' },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>